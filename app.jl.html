<q-layout view="hHh lpR fFf" :class="theme">
    <q-header elevated class="bg-primary text-white">
        <q-toolbar>
            <q-toolbar-title>Investment Calculator</q-toolbar-title>
            <q-btn flat round :icon="darkmode ? 'light_mode' : 'dark_mode'" @click="darkmode = !darkmode"/>
        </q-toolbar>
    </q-header>

    <q-page-container>
        <div class="container q-pa-md">
            <header>
                <h4>Investment Calculator</h4>
            </header>
            <div class="row q-pa-md">
                <div class="col-12">
                    <h4>Project Parameters</h4>
                </div>
                <div class="col-md-4 q-pa-sm">
                    <q-input 
                        v-model.number="land_cost" 
                        type="number" 
                        label="Land Cost" 
                        filled 
                    />
                </div>
                <div class="col-md-4 q-pa-sm">
                    <q-input 
                        v-model.number="num_rooms" 
                        type="number" 
                        label="Number of Rooms" 
                        filled 
                    />
                </div>
                <div class="col-md-4 q-pa-sm">
                    <q-input 
                        v-model.number="nightly_rate" 
                        type="number" 
                        label="Nightly Rate" 
                        filled 
                    />
                </div>
                <div class="col-md-4 q-pa-sm">
                    <q-input 
                        v-model.number="occupancy_rate" 
                        type="number" 
                        label="Occupancy Rate (0-1)" 
                        filled 
                    />
                </div>
                <div class="col-md-12 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Monthly Operating Costs</div>
                            <div class="row q-mb-md items-end">
                                <div class="col-md-4 q-px-sm">
                                    <q-input 
                                        v-model="new_cost_name" 
                                        label="Cost Name" 
                                        filled 
                                    />
                                </div>
                                <div class="col-md-4 q-px-sm">
                                    <q-input 
                                        v-model.number="new_cost_amount" 
                                        type="number" 
                                        label="Monthly Amount" 
                                        filled 
                                    />
                                </div>
                                <div class="col-md-4 q-px-sm">
                                    <q-btn color="primary" v-on:click="add_cost = true" :loading="add_cost">Add Cost</q-btn>
                                </div>
                            </div>

                            <q-table
                                :rows="operating_costs"
                                :columns="[
                                    {name: 'name', label: 'Cost Item', field: 'name', align: 'left'},
                                    {name: 'amount', label: 'Monthly Amount', field: 'amount', format: val => val.toLocaleString('en-US', {style: 'currency', currency: 'USD'}), align: 'right'},
                                    {name: 'actions', label: 'Actions', align: 'center'}
                                ]"
                                row-key="name"
                                flat
                                bordered
                            >
                                <template v-slot:body="props">
                                    <q-tr :props="props">
                                        <q-td key="name" :props="props">{{ props.row.name }}</q-td>
                                        <q-td key="amount" :props="props">{{ props.row.amount.toLocaleString('en-US', {style: 'currency', currency: 'USD'}) }}</q-td>
                                        <q-td key="actions" :props="props">
                                            <q-btn size="sm" color="negative" round icon="delete" v-on:click="remove_cost = true" :loading="remove_cost" />
                                        </q-td>
                                    </q-tr>
                                </template>
                                <template v-slot:bottom-row>
                                    <q-tr>
                                        <q-td colspan="1" class="text-right">Total:</q-td>
                                        <q-td class="text-right">{{ monthly_operating_costs.toLocaleString('en-US', {style: 'currency', currency: 'USD'}) }}</q-td>
                                        <q-td></q-td>
                                    </q-tr>
                                </template>
                            </q-table>
                        </q-card-section>
                    </q-card>
                </div>
            </div>

            <div class="row q-pa-md">
                <div class="col-12">
                    <h4>Investment Structure</h4>
                </div>
                <div class="col-md-6 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="row q-mb-md items-end">
                                <div class="col-md-4 q-px-sm">
                                    <q-input 
                                        v-model="new_investor_name" 
                                        label="Investor Name" 
                                        filled 
                                    />
                                </div>
                                <div class="col-md-4 q-px-sm">
                                    <q-input 
                                        v-model.number="new_investor_amount" 
                                        type="number" 
                                        label="Investment Amount" 
                                        filled 
                                    />
                                </div>
                                <div class="col-md-4 q-px-sm">
                                    <q-btn color="primary" v-on:click="add_investor = true" :loading="add_investor">Add Investor</q-btn>
                                </div>
                            </div>

                            <q-table
                                :rows="investors"
                                :columns="[
                                    {name: 'name', label: 'Name', field: 'name', align: 'left'},
                                    {name: 'amount', label: 'Amount', field: 'amount', format: val => val.toLocaleString('en-US', {style: 'currency', currency: 'USD'}), align: 'right'},
                                    {name: 'actions', label: 'Actions', align: 'center'}
                                ]"
                                row-key="name"
                                flat
                                bordered
                            >
                                <template v-slot:body="props">
                                    <q-tr :props="props">
                                        <q-td key="name" :props="props">{{ props.row.name }}</q-td>
                                        <q-td key="amount" :props="props">{{ props.row.amount.toLocaleString('en-US', {style: 'currency', currency: 'USD'}) }}</q-td>
                                        <q-td key="actions" :props="props">
                                            <q-btn size="sm" color="negative" round icon="delete" v-on:click="remove_investor = true" :loading="remove_investor" />
                                        </q-td>
                                    </q-tr>
                                </template>
                            </q-table>
                        </q-card-section>
                    </q-card>
                </div>
                <div class="col-md-6 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <plotly 
                                :data="investment_plot" 
                                :layout="investment_layout"
                                style="width:100%;height:400px"
                            />
                        </q-card-section>
                    </q-card>
                </div>
            </div>

            <div class="row q-pa-md">
                <div class="col-12">
                    <h4>Financial Overview</h4>
                </div>
                <div class="col-md-4 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Monthly Revenue</div>
                            <div class="text-h4">{{monthly_revenue.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}}</div>
                        </q-card-section>
                    </q-card>
                </div>
                <div class="col-md-4 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Break-even Time</div>
                            <div class="text-h4">
                                <span v-if="investors.length > 0">
                                    <span v-if="investors[0].breakeven_years > 0">{{ investors[0].breakeven_years }}y </span>
                                    <span v-if="investors[0].breakeven_months > 0">{{ investors[0].breakeven_months }}m </span>
                                    <span v-if="investors[0].breakeven_days > 0">{{ investors[0].breakeven_days }}d</span>
                                    <span v-if="investors[0].breakeven_years === 0 && investors[0].breakeven_months === 0 && investors[0].breakeven_days === 0">Never breaks even</span>
                                </span>
                                <span v-else>No investors</span>
                            </div>
                        </q-card-section>
                    </q-card>
                </div>
                <div class="col-md-4 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Monthly Profit</div>
                            <div class="text-h4">{{monthly_profit.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}}</div>
                        </q-card-section>
                    </q-card>
                </div>
                <!-- Profit Distribution Cards -->
                <div class="col-md-12 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Profit Distribution</div>
                            <div class="row q-mt-md">
                                <template v-for="investor in investors">
                                    <div class="col-md-6 q-pa-sm">
                                        <q-card>
                                            <q-card-section>
                                                <div class="text-h6 text-capitalize">{{ investor.name }}</div>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="text-subtitle2">Equity Share</div>
                                                        <div class="text-h5">{{ investor.equity.toFixed(1) }}%</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-subtitle2">Monthly Profit</div>
                                                        <div class="text-h5">{{ investor.monthly_profit.toLocaleString('en-US', {style: 'currency', currency: 'USD'}) }}</div>
                                                    </div>
                                                </div>
                                            </q-card-section>
                                        </q-card>
                                    </div>
                                </template>
                            </div>
                        </q-card-section>
                    </q-card>
                </div>
            </div>

            <div class="row q-pa-md">
                <div class="col-12">
                    <h4>Monthly Financial Breakdown</h4>
                </div>
                <div class="col-md-12 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <plotly
                                :data="[{
                                    x: financial_labels,
                                    y: financial_values,
                                    type: 'bar',
                                    marker: {
                                        color: financial_colors
                                    },
                                    text: financial_values.map(v => v.toLocaleString('en-US', {
                                        style: 'currency',
                                        currency: 'USD'
                                    })),
                                    textposition: 'auto'
                                }]"
                                :layout="{
                                    title: 'Monthly Financial Metrics',
                                    yaxis: { 
                                        title: 'Amount',
                                        showgrid: true
                                    },
                                    height: 400,
                                    bargap: 0.3
                                }"
                            />
                        </q-card-section>
                    </q-card>
                </div>
            </div>

            <div class="row q-pa-md">
                <div class="col-12">
                    <h4>Property Value Projections</h4>
                </div>
                <div class="col-md-3 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Year 1</div>
                            <div class="text-h4">{{year1_value.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}}</div>
                        </q-card-section>
                    </q-card>
                </div>
                <div class="col-md-3 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Year 3</div>
                            <div class="text-h4">{{year3_value.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}}</div>
                        </q-card-section>
                    </q-card>
                </div>
                <div class="col-md-3 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Year 5</div>
                            <div class="text-h4">{{year5_value.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}}</div>
                        </q-card-section>
                    </q-card>
                </div>
                <div class="col-md-3 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <div class="text-h6">Year 10</div>
                            <div class="text-h4">{{year10_value.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}}</div>
                        </q-card-section>
                    </q-card>
                </div>
            </div>

            <div class="row q-pa-md">
                <div class="col-12">
                    <h4>Property Value Chart</h4>
                </div>
                <div class="col-md-12 q-pa-sm">
                    <q-card>
                        <q-card-section>
                            <plotly
                                :data="property_chart_data"
                                :layout="property_chart_layout"
                            />
                        </q-card-section>
                    </q-card>
                </div>
            </div>
        </div>
    </q-page-container>
</q-layout>
